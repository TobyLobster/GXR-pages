<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<title>Chapter 4: ROM header and service entry routines</title>
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Breadcrumbs.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Carousel.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Navigation.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Base.css" rel="stylesheet" rev="stylesheet" type="text/css">
		<meta name="viewport" content="width=device-width initial-scale=1">
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Content-Language" content="en-gb">

<link href="../docs-assets/Contents.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Progress.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Fonts.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/Popups.css" rel="stylesheet" rev="stylesheet" type="text/css">
<script>
function togglePopup(material_id) {
  var popup = document.getElementById(material_id);
  popup.classList.toggle("show");
}
</script>

<link href="../docs-assets/Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
<link href="../docs-assets/ACME-Colours.css" rel="stylesheet" rev="stylesheet" type="text/css">
		
	</head>
	<body class="commentary-font">
		<nav role="navigation">
		<p>BBC Computer 32K</p>
<h1>*GXR</h1>
<ul><li><a href="../index.html">&#x21A9; home</a></li><li><a href="index.html"><span class="selectedlink">contents</span></a></li>
<li><a href="S-s1.html">introduction</a></li>
<li><a href="S-s2.html">constants</a></li>
<li><a href="S-s3.html">memory addresses</a></li>
<li><span class="unlink"><b>$8000</b>: chapter 4</span></li>
<li><a href="S-s5.html"><b>$8167</b>: chapter 5</a></li>
<li><a href="S-s6.html"><b>$82a9</b>: chapter 6</a></li>
<li><a href="S-s7.html"><b>$8349</b>: chapter 7</a></li>
<li><a href="S-s8.html"><b>$88f9</b>: chapter 8</a></li>
<li><a href="S-s9.html"><b>$8955</b>: chapter 9</a></li>
<li><a href="S-s10.html"><b>$899d</b>: chapter 10</a></li>
<li><a href="S-s11.html"><b>$8a8a</b>: chapter 11</a></li>
<li><a href="S-s12.html"><b>$8bb4</b>: chapter 12</a></li>
<li><a href="S-s13.html"><b>$8d83</b>: chapter 13</a></li>
<li><a href="S-s14.html"><b>$8dd2</b>: chapter 14</a></li>
<li><a href="S-s15.html"><b>$8e5b</b>: chapter 15</a></li>
<li><a href="S-s16.html"><b>$9044</b>: chapter 16</a></li>
<li><a href="S-s17.html"><b>$9872</b>: chapter 17</a></li>
<li><a href="S-s18.html"><b>$9ced</b>: chapter 18</a></li>
<li><a href="S-s19.html"><b>$9f7c</b>: chapter 19</a></li>
<li><a href="S-s20.html"><b>$a258</b>: chapter 20</a></li>
<li><a href="S-s21.html"><b>$a40e</b>: chapter 21</a></li>
<li><a href="S-s22.html"><b>$a808</b>: chapter 22</a></li>
<li><a href="S-s23.html"><b>$b9ea</b>: chapter 23</a></li>
<li><a href="S-s24.html"><b>$bdd0</b>: chapter 24</a></li>
<li><a href="S-s25.html"><b>$bfdb</b>: chapter 25</a></li>

</ul>
		</nav>
		<main role="main">
		<!--Weave of 'Chapter 4: ROM header and service entry routines' generated by Inweb-->
<div class="breadcrumbs">
    <ul class="crumbs"><li><a href="../index.html">Home</a></li><li><a href="index.html">GXR</a></li><li><b>Chapter 4: ROM header and service entry routines</b></li></ul></div>
<p class="purpose">How the OS and ROM communicate - 359 bytes (2.1%)</p>

<ul class="toc"><li><a href="S-s4.html#SP1">&#167;1. ROM header</a></li><li><a href="S-s4.html#SP2">&#167;2. ROM service entry routine</a></li><li><a href="S-s4.html#SP3">&#167;3. Called on a hard reset</a></li><li><a href="S-s4.html#SP4">&#167;4. Claim private workspace memory</a></li></ul><hr class="tocbar">

<p class="commentary firstcommentary"><a id="SP1" class="paragraph-anchor"></a><b>&#167;1. ROM header. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Every Sideways ROM requires a header (including a copyright string) in order to be identified</span>
<span class="ACME-plain-syntax"> as a ROM. The 'ROM type' byte indicates the type of ROM: we are a service ROM (not a language</span>
<span class="ACME-plain-syntax"> ROM) with a service entry point and it is written in 6502.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">* = </span><span class="ACME-constant-syntax">$8000</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"RCM"</span><span class="ACME-plain-syntax">                                         </span><span class="ACME-comment-syntax">normally a language entry point,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">('JMP address') but this is not a</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">language ROM so these bytes are</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">unused. 'RCM' is probably the</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">initials of Richard Manby who wrote</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">most of this code.</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP2" class="function-link"><span class="ACME-function-syntax">serviceEntryRoutine</span></a><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">service entry point</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$82</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">ROM type byte:</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  $82 means it's not a language ROM,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  has a service entry point,</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">  and is 6502 code (not BASIC)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP1" class="function-link"><span class="ACME-function-syntax">copyrightString</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$8000</span><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">offset to copyright string (-1)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">$01</span><span class="ACME-plain-syntax">                                           </span><span class="ACME-comment-syntax">binary version number</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">titleString</span><button class="popup" onclick="togglePopup('usagePopup1')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup1">Usage of <span class="code-font"><span class="ACME-function-syntax">titleString</span></span>:<br/>Chapter 7: Parsing *HELP Commands - <a href="S-s7.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8009</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"Graphics Extension ROM "</span><span class="ACME-plain-syntax">,.</span><a href="S-s2.html#SP1" class="function-link"><span class="ACME-function-syntax">fullVersion</span></a><span class="ACME-plain-syntax">,.</span><a href="S-s2.html#SP2" class="function-link"><span class="ACME-function-syntax">charLF</span></a><span class="ACME-plain-syntax">,.</span><a href="S-s2.html#SP2" class="function-link"><span class="ACME-function-syntax">charCR</span></a>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">0</span><span class="ACME-plain-syntax">                                             </span><span class="ACME-comment-syntax">terminator</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">(no version string)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">copyrightString</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8027</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!text</span><span class="ACME-plain-syntax"> </span><span class="ACME-string-syntax">"(C)1985 Acornsoft"</span><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">copyright string</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-element-syntax">!byte</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">0</span><span class="ACME-plain-syntax">                                             </span><span class="ACME-comment-syntax">terminator</span>
</pre>
<p class="commentary firstcommentary"><a id="SP2" class="paragraph-anchor"></a><b>&#167;2. ROM service entry routine. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> ROMs with a service entry point (as indicated by the ROM type byte in the ROM header) receive</span>
<span class="ACME-plain-syntax"> calls from the OS. The service call type is passed in the accumulator. If the ROM handles the</span>
<span class="ACME-plain-syntax"> call, it returns with A=0. If the service call is not handled, the accumulator must be returned</span>
<span class="ACME-plain-syntax"> unchanged.</span>

<span class="ACME-plain-syntax"> The GXR handles four of the service calls, as shown below.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">serviceEntryRoutine</span><button class="popup" onclick="togglePopup('usagePopup2')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup2">Usage of <span class="code-font"><span class="ACME-function-syntax">serviceEntryRoutine</span></span>:<br/><a href="S-s4.html#SP1">&#167;1</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8039</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for service call to claim private workspace</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">relative private workspace claim?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP4" class="function-link"><span class="ACME-function-syntax">serviceRelativePrivateWorkspaceClaim</span></a><span class="ACME-plain-syntax">           </span><span class="ACME-comment-syntax">branch if so</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for service call indicating an unknown OSBYTE (*FX) call</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #7                                              </span><span class="ACME-comment-syntax">unrecognised OSBYTE call?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not OSBYTE) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s6.html#SP5" class="function-link"><span class="ACME-function-syntax">handleOSBYTECall</span></a><span class="ACME-plain-syntax">                               </span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for service call indicating *HELP</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #9                                              </span><span class="ACME-comment-syntax">*HELP command?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not *HELP) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s7.html#SP1" class="function-link"><span class="ACME-function-syntax">handleStarHelp</span></a><span class="ACME-plain-syntax">                                 </span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for service call indicating an unrecognised *command</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #4                                              </span><span class="ACME-comment-syntax">unrecognised star command?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not star command) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s5.html#SP1" class="function-link"><span class="ACME-function-syntax">handleUnrecognisedStarCommand</span></a><span class="ACME-plain-syntax">                  </span>
<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">exit with A preserved, so call is</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">passed on to the next ROM</span>
</pre>
<p class="commentary firstcommentary"><a id="SP3" class="paragraph-anchor"></a><b>&#167;3. Called on a hard reset. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> Reset the ROM workspace byte to zero (this marks the ROM as inactive, no memory claimed yet), and</span>
<span class="ACME-plain-syntax"> check the ROM number. If odd, then we initialise the ROM, otherwise we remain inactive and pass on</span>
<span class="ACME-plain-syntax"> the service call to the next ROM. See the next section for more of an explanation.</span>

<span class="ACME-plain-syntax"> On Entry:</span>
<span class="ACME-plain-syntax">   X is the ROM number</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">lastResetWasHardReset</span><button class="popup" onclick="togglePopup('usagePopup3')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup3">Usage of <span class="code-font"><span class="ACME-function-syntax">lastResetWasHardReset</span></span>:<br/><a href="S-s4.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8053</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">store zero into ROM workspace byte</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">romWorkspaceBytes</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">(high byte of private workspace)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TXA</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-element-syntax">!if</span><span class="ACME-plain-syntax"> </span><span class="ACME-reserved-syntax">MACHINE</span><span class="ACME-plain-syntax"> = </span><span class="ACME-reserved-syntax">BBC_B</span><span class="ACME-plain-syntax"> {</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #1</span>
<span class="ACME-plain-syntax">} </span><span class="ACME-reserved-syntax">else</span><span class="ACME-plain-syntax"> </span><span class="ACME-reserved-syntax">if</span><span class="ACME-plain-syntax"> </span><span class="ACME-reserved-syntax">MACHINE</span><span class="ACME-plain-syntax"> = </span><span class="ACME-reserved-syntax">BBC_B_PLUS</span><span class="ACME-plain-syntax"> {</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #2</span>
<span class="ACME-plain-syntax">} </span><span class="ACME-reserved-syntax">else</span><span class="ACME-plain-syntax"> </span><span class="ACME-reserved-syntax">if</span><span class="ACME-plain-syntax"> </span><span class="ACME-reserved-syntax">MACHINE</span><span class="ACME-plain-syntax"> = </span><span class="ACME-reserved-syntax">ELECTRON</span><span class="ACME-plain-syntax"> {</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">NOTE: What's the best rule for deciding default on/off for an Electron?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">I suspect a 1980s cartridge release for use with the Plus 1 would have</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">done AND #2 so one cartridge would enable it by default and the other</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">wouldn't.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #1</span>
<span class="ACME-plain-syntax">} </span><span class="ACME-reserved-syntax">else</span><span class="ACME-plain-syntax"> {</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-identifier-syntax">+</span><span class="ACME-reserved-syntax">unknown_machine</span>
<span class="ACME-plain-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP4" class="function-link"><span class="ACME-function-syntax">claimWorkspace</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (ROM number is odd) then branch</span>
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">passOnToNextROM</span><button class="popup" onclick="togglePopup('usagePopup4')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup4">Usage of <span class="code-font"><span class="ACME-function-syntax">passOnToNextROM</span></span>:<br/><a href="S-s4.html#SP4">&#167;4</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $805d</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #2                                              </span><span class="ACME-comment-syntax">set A to 'relative private workspace</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">claim' for the next ROM to check</span>
</pre>
<p class="commentary firstcommentary"><a id="SP4" class="paragraph-anchor"></a><b>&#167;4. Claim private workspace memory. </b></p>

<pre class="ACME-undisplayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax"> On a reset, the ROM receives a service call to claim the private workspace memory it needs.</span>

<span class="ACME-plain-syntax"> Private workspace is memory required by the GXR (a) to store the current state of the system,</span>
<span class="ACME-plain-syntax"> (b) for a flood fill buffer and (c) to store sprites.</span>

<span class="ACME-plain-syntax"> There is one case where the GXR is not enabled. On a power on or hard reset (CTRL-Break) if</span>
<span class="ACME-plain-syntax"> the GXR is in an even numbered ROM socket it does not claim any memory and is inactive until</span>
<span class="ACME-plain-syntax"> the *GXR command is given. The inactive GXR state is a useful default as it doesn't consume</span>
<span class="ACME-plain-syntax"> memory (doesn't raise PAGE), which generally gives better compatibility with games and other</span>
<span class="ACME-plain-syntax"> software.</span>

<span class="ACME-plain-syntax"> The ROM workspace byte:</span>

<span class="ACME-plain-syntax"> Each ROM can store a single byte of state at .romWorkspaceBytes,X (where X is the ROM number)</span>

<span class="ACME-plain-syntax"> * An inactive GXR has the byte set to zero.</span>
<span class="ACME-plain-syntax"> * If the GXR is becoming active, then it is one.</span>
<span class="ACME-plain-syntax"> * If the GXR is becoming inactive, then it is zero.</span>
<span class="ACME-plain-syntax"> * If the GXR is already active, then it stores the page number of its private workspace.</span>

<span class="ACME-plain-syntax"> An active GXR ROM can be made inactive using *NOGXR.</span>

<span class="ACME-plain-syntax"> Since this memory allocation only happens on a reset, the user is prompted to 'Press BREAK'</span>
<span class="ACME-plain-syntax"> after using any of the *commands that change the required memory use.</span>
</pre>
<pre class="ACME-displayed-code all-displayed-code code-font">
<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">serviceRelativePrivateWorkspaceClaim</span><button class="popup" onclick="togglePopup('usagePopup5')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup5">Usage of <span class="code-font"><span class="ACME-function-syntax">serviceRelativePrivateWorkspaceClaim</span></span>:<br/><a href="S-s4.html#SP2">&#167;2</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8060</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Remember parameters</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceA</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">store service call number (A=2)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceC</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">store Y=first available page</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s8.html#SP2" class="function-link"><span class="ACME-function-syntax">getPrivateWorkspaceAddress</span></a><span class="ACME-plain-syntax">                     </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceHigh</span></a><span class="ACME-plain-syntax">                           </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (no workspace set) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check if soft character definitions have already been cached</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetHasCachedSoftCharacterDefinitions</span></a><span class="ACME-plain-syntax"> </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (not cached already) then branch</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Restore the character definitions if they were already cached in the workspace area</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s12.html#SP4" class="function-link"><span class="ACME-function-syntax">copyWorkspaceCacheBackIntoCharacterDefinitons</span></a><span class="ACME-plain-syntax">  </span>
<span class="ACME-identifier-syntax">+</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Store the first available page as our workspace address</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceC</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">private workspace page</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STY</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceHigh</span></a><span class="ACME-plain-syntax">                           </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">lastResetType</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">what type of reset was last done?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #3                                              </span><span class="ACME-comment-syntax">   0    Soft reset (BREAK)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">   1    Power on</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">   2    Hard reset (CTRL-BREAK)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">[NOTE: Arguably should use OSBYTE</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">$FD]</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP3" class="function-link"><span class="ACME-function-syntax">lastResetWasHardReset</span></a><span class="ACME-plain-syntax">                          </span><span class="ACME-comment-syntax">if (not a soft reset) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Soft reset</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">romWorkspaceBytes</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">(high byte of private workspace)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP3" class="function-link"><span class="ACME-function-syntax">passOnToNextROM</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">if (GXR not active) then branch</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">(pass on to next ROM)</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">claimWorkspace</span><button class="popup" onclick="togglePopup('usagePopup6')"><span class="ACME-comment-syntax">?</span><span class="popuptext" id="usagePopup6">Usage of <span class="code-font"><span class="ACME-function-syntax">claimWorkspace</span></span>:<br/><a href="S-s4.html#SP3">&#167;3</a></span></button><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $8087</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TYA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A = Y = first available page</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">romWorkspaceBytes</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">have we already got this space?</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP4" class="function-link"><span class="ACME-function-syntax">alreadyClaimed</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">if (already claimed) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">not already claimed, so claim it</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">romWorkspaceBytes</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">X</span><span class="ACME-plain-syntax">                            </span><span class="ACME-comment-syntax">store amount of claimed space</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">No sprite chosen by default</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetChosenSpriteIndex</span></a><span class="ACME-plain-syntax">              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">workspace[chosen sprite index] = 0</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Zero sprites initially</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetNumberOfSprites</span></a><span class="ACME-plain-syntax">                </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">workspace[number of sprites] = 0</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Zero sprite pages</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=#.workspaceOffsetSpritePages</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">workspace[sprite pages] = 0</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Flood fill enabled by default</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=#.workspaceOffsetOptions</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$80</span><span class="ACME-plain-syntax">                                            </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">workspace[options] = $80 (flood</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">enabled)</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Record three pages used</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">Y=#.workspaceOffsetTotalPagesWithoutSprites</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #3                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">workspace[#pages without sprites] = 3</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">alreadyClaimed</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $80a7</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Store sprite address</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetChosenSpriteAddressLow</span></a><span class="ACME-plain-syntax">         </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDC</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">} tempStoreDC/DD = sprite address</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDD</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check for an existing chosen sprite</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=#.workspaceOffsetChosenSpriteIndex</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax">                                               </span><span class="ACME-comment-syntax">if (no chosen sprite) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Set currently chosen sprite to zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAX</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">X = chosen sprite</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} workspace[currently chosen sprite]</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} = 0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s21.html#SP9" class="function-link"><span class="ACME-function-syntax">addSpriteLoop</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">ensure the sprite is back in sprite</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">memory properly</span>

<span class="ACME-identifier-syntax">+</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Check if flood fill is pending, due to be activated</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetOptions</span></a><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">AND</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$C0</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">} Check top two bits of options.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CMP</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$40</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">} check top bit is clear (previously</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} non flood mode) and bit 6 is set</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} (flood mode is pending)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BNE</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP4" class="function-link"><span class="ACME-function-syntax">notActivatingFlood</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">} if (we are not activating flood)</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Activate flood mode</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A=$80 (shifts bit 6 to bit 7) making</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">flood enabled</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">store in options</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">Y=#.workspaceOffsetSpritePages</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BEQ</span><span class="ACME-plain-syntax"> .</span><a href="S-s4.html#SP4" class="function-link"><span class="ACME-function-syntax">notActivatingFlood</span></a><span class="ACME-plain-syntax">                             </span><span class="ACME-comment-syntax">if (no sprite pages) then branch</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Copy all the sprite data 2 pages further in memory to make room for the two pages of</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">flood fill data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDF</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">tempStoreDF = number of sprite pages</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDA</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">} set low bytes to zero</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDC</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDE</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetSpriteStartPage</span></a><span class="ACME-plain-syntax">                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} tempStoreDD = sprite start page</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDD</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> #2                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vduTempStoreDB</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">tempStoreDB = sprite data plus two</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">pages</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s13.html#SP2" class="function-link"><span class="ACME-function-syntax">blockCopyMemoryDecrementing</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">copy tempStoreDE/DF bytes from</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">tempStoreDC/DD to tempStoreDA/DB</span>

<span class="ACME-plain-syntax">.</span><span class="ACME-function-syntax">notActivatingFlood</span><span class="ACME-plain-syntax"> </span><span class="ACME-comment-syntax">= $80e9</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Calculate how many pages we use (1 or 3) until the sprite data</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetOptions</span></a><span class="ACME-plain-syntax">                        </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">A = workspace[options]</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ASL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">carry = flood enabled</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #</span><span class="ACME-constant-syntax">$80</span><span class="ACME-plain-syntax">                                            </span><span class="ACME-comment-syntax">A = $80</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A = carry, carry = 1</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ROL</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">A = 2*carry + 1 = number of pages</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">required (1 or 3), carry = 0</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceHigh</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">add current workspace page</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Store sprite start page</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetSpriteStartPage</span></a><span class="ACME-plain-syntax">                </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">set workspace[sprite page] =  page</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">after workspace</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s10.html#SP7" class="function-link"><span class="ACME-function-syntax">resetCurrentSpriteAddress</span></a><span class="ACME-plain-syntax">                      </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Copy the code at .gxrOSWRCH into our workspace so we can intercept OSWRCH calls.</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s10.html#SP1" class="function-link"><span class="ACME-function-syntax">notCompatible</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax">                </span>
<span class="ACME-identifier-syntax">-</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax">,</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                                    </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">BPL</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax">                                               </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Patch in the appropriate addresses / values into the code</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">jmpOldWRCHPatch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax">                  </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorWRCHVLow</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PHA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} workspace[patch] =</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} vectorWRCHVLow/High</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">INY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorWRCHVHigh</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">jsrOldWRCHPatch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">+</span><span class="ACME-plain-syntax"> </span><span class="ACME-constant-syntax">1</span><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax">              </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">} workspace[patch + 1] =</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} vectorWRCHVLow/High</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">DEY</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">PLA</span><span class="ACME-plain-syntax">                                                 </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">ldaOurWRCHHighPatch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax">              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceC</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">insert high byte of our code into</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">.gxrOSWRCH to write into jump vector</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s9.html#SP2" class="function-link"><span class="ACME-function-syntax">ldaOurRomBankPatch</span></a><span class="ACME-plain-syntax"> </span><span class="ACME-identifier-syntax">-</span><span class="ACME-plain-syntax"> .</span><a href="S-s9.html#SP1" class="function-link"><span class="ACME-function-syntax">gxrOSWRCH</span></a><span class="ACME-plain-syntax">               </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">currentlySelectedROM</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">insert currently selected ROM into</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">.gxrOSWRCH code at label</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">'.ldaOurRomBankPatch'</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s8.html#SP1" class="function-link"><span class="ACME-function-syntax">swapWorkspaceWithVDUVectors</span></a><span class="ACME-plain-syntax">                    </span><span class="ACME-comment-syntax">swap in our VDUV routine</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Handle the extended VDU vector</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&lt;.</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">extendedVectorTableVDUV</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorVDUVLow</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&gt;.</span><a href="S-s3.html#SP10" class="function-link"><span class="ACME-function-syntax">extendedVectorTableVDUV</span></a><span class="ACME-plain-syntax">                      </span><span class="ACME-comment-syntax">} Extended vector E_VDUV at $FF39</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorVDUVHigh</span></a><span class="ACME-plain-syntax">                                 </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&lt;.</span><a href="S-s12.html#SP6" class="function-link"><span class="ACME-function-syntax">extendedVectorVDURoutine</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">extendedVDUVLow</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #&gt;.</span><a href="S-s12.html#SP6" class="function-link"><span class="ACME-function-syntax">extendedVectorVDURoutine</span></a><span class="ACME-plain-syntax">                     </span><span class="ACME-comment-syntax">}</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">extendedVDUVHigh</span></a><span class="ACME-plain-syntax">                               </span><span class="ACME-comment-syntax">} Point at our extended vector</span>
<span class="ACME-plain-syntax">                                                        </span><span class="ACME-comment-syntax">} routine</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">currentlySelectedROM</span></a><span class="ACME-plain-syntax">                           </span><span class="ACME-comment-syntax">} and ROM number</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP7" class="function-link"><span class="ACME-function-syntax">extendedVDUVROM</span></a><span class="ACME-plain-syntax">                                </span><span class="ACME-comment-syntax">}</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Reset patterns</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s12.html#SP8" class="function-link"><span class="ACME-function-syntax">resetPatternFillsToDefaults</span></a><span class="ACME-plain-syntax">                    </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Reset dot-dash pattern</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">JSR</span><span class="ACME-plain-syntax"> .</span><a href="S-s6.html#SP6" class="function-link"><span class="ACME-function-syntax">setDotPatternAndRepeat</span></a><span class="ACME-plain-syntax">                         </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Set the OSWRCH vector to point to our gxrOSWRCH (at the start of our private workspace)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">CLC</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> #0                                              </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorWRCHVLow</span></a><span class="ACME-plain-syntax">                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceC</span></a><span class="ACME-plain-syntax">                                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">vectorWRCHVHigh</span></a><span class="ACME-plain-syntax">                                </span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Calculate sprite end page = sprite start page initially</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetTotalPagesWithoutSprites</span></a><span class="ACME-plain-syntax">       </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">ADC</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">add total pages without sprites</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDY</span><span class="ACME-plain-syntax"> #.</span><a href="S-s2.html#SP3" class="function-link"><span class="ACME-function-syntax">workspaceOffsetSpriteEndPage</span></a><span class="ACME-plain-syntax">                  </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">STA</span><span class="ACME-plain-syntax"> (.</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">privateWorkspaceLow</span></a><span class="ACME-plain-syntax">),</span><span class="ACME-reserved-syntax">Y</span><span class="ACME-plain-syntax">                        </span><span class="ACME-comment-syntax">store as end page</span>

<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">Leave with Y=end page (i.e. next unused page), X=ROM number, A=2 (the service call</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-comment-syntax">number)</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">TAY</span><span class="ACME-plain-syntax">                                                 </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDX</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP2" class="function-link"><span class="ACME-function-syntax">currentlySelectedROM</span></a><span class="ACME-plain-syntax">                           </span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">LDA</span><span class="ACME-plain-syntax"> .</span><a href="S-s3.html#SP4" class="function-link"><span class="ACME-function-syntax">vduWorkspaceA</span></a><span class="ACME-plain-syntax">                                  </span><span class="ACME-comment-syntax">A=2</span>
<span class="ACME-plain-syntax">    </span><span class="ACME-reserved-syntax">RTS</span><span class="ACME-plain-syntax">                                                 </span>
</pre>
<nav role="progress"><div class="progresscontainer">
    <ul class="progressbar"><li class="progressprev"><a href="S-s3.html">&#10094;</a></li><li class="progresssection"><a href="S-s1.html">1</a></li><li class="progresssection"><a href="S-s2.html">2</a></li><li class="progresssection"><a href="S-s3.html">3</a></li><li class="progresscurrent">4</li><li class="progresssection"><a href="S-s5.html">5</a></li><li class="progresssection"><a href="S-s6.html">6</a></li><li class="progresssection"><a href="S-s7.html">7</a></li><li class="progresssection"><a href="S-s8.html">8</a></li><li class="progresssection"><a href="S-s9.html">9</a></li><li class="progresssection"><a href="S-s10.html">10</a></li><li class="progresssection"><a href="S-s11.html">11</a></li><li class="progresssection"><a href="S-s12.html">12</a></li><li class="progresssection"><a href="S-s13.html">13</a></li><li class="progresssection"><a href="S-s14.html">14</a></li><li class="progresssection"><a href="S-s15.html">15</a></li><li class="progresssection"><a href="S-s16.html">16</a></li><li class="progresssection"><a href="S-s17.html">17</a></li><li class="progresssection"><a href="S-s18.html">18</a></li><li class="progresssection"><a href="S-s19.html">19</a></li><li class="progresssection"><a href="S-s20.html">20</a></li><li class="progresssection"><a href="S-s21.html">21</a></li><li class="progresssection"><a href="S-s22.html">22</a></li><li class="progresssection"><a href="S-s23.html">23</a></li><li class="progresssection"><a href="S-s24.html">24</a></li><li class="progresssection"><a href="S-s25.html">25</a></li><li class="progressnext"><a href="S-s5.html">&#10095;</a></li></ul></div>
</nav><!--End of weave-->

		</main>
	</body>
</html>

